#!/usr/bin/env bash
# Generated by tmux-setup installer from templates/devstack.template
# Configuration: {{CONFIG_FILE}}
# Generated: {{TIMESTAMP}}

set -e

# ============================================================================
# Configuration Variables (from setup.yaml)
# ============================================================================

SESSION_BASE="{{SESSION_NAME}}"
WINDOW="{{WINDOW_NAME}}"
ANCESTOR="{{ANCESTOR_PATH}}"
CHILDREN=(
{{CHILDREN_PATHS}}
)

# Git remote configuration
{{GIT_REMOTE_CONFIG}}

# ============================================================================
# Command-line Argument Parsing
# ============================================================================

# Parse flags
AUTO_START_CLAUDE={{AUTO_START_CLAUDE}}
INSTANCE_NAME=""

for arg in "$@"; do
  case $arg in
    --claude)
      AUTO_START_CLAUDE=true
      shift
      ;;
    --instance=*)
      INSTANCE_NAME="${arg#*=}"
      shift
      ;;
    --help|-h)
      echo "Usage: devstack [OPTIONS]"
      echo ""
      echo "Options:"
      echo "  --claude              Auto-start Claude CLI in all panes"
      echo "  --instance=NAME       Create named instance (session: {{SESSION_NAME}}-NAME)"
      echo "  --help, -h            Show this help message"
      echo ""
      echo "Examples:"
      echo "  devstack                          # Start default session"
      echo "  devstack --claude                 # Start with Claude CLI"
      echo "  devstack --instance=feature       # Named instance"
      echo "  devstack --instance=bug --claude  # Named instance with Claude"
      exit 0
      ;;
    *)
      # Unknown argument
      ;;
  esac
done

# ============================================================================
# Session Name Construction
# ============================================================================

# Build session name
if [[ -n "$INSTANCE_NAME" ]]; then
  SESSION="${SESSION_BASE}-${INSTANCE_NAME}"
else
  SESSION="$SESSION_BASE"
fi

# ============================================================================
# Session Existence Check
# ============================================================================

# Check if session exists
if tmux has-session -t "$SESSION" 2>/dev/null; then
  echo "✓ Session '$SESSION' already exists. Attaching..."
  tmux attach-session -t "$SESSION"
  exit 0
fi

echo "✓ Creating new session '$SESSION'..."

# ============================================================================
# Session and Pane Creation
# ============================================================================

# Create session with pane 0 (ancestor)
tmux new-session -d -s "$SESSION" -n "$WINDOW" -c "$ANCESTOR"

# Create panes 1-3 (children)
tmux split-window -h -t "$SESSION:$WINDOW.0" -c "${CHILDREN[0]}"
tmux split-window -v -t "$SESSION:$WINDOW.1" -c "${CHILDREN[1]}"
tmux split-window -v -t "$SESSION:$WINDOW.2" -c "${CHILDREN[2]}"

# ============================================================================
# Layout Application
# ============================================================================

# Apply layout: {{LAYOUT_NAME}} ({{LAYOUT_DESCRIPTION}})
tmux select-layout -t "$SESSION:$WINDOW" {{LAYOUT_TMUX}}

# ============================================================================
# Pane Styling and Titles
# ============================================================================

{{PANE_BORDER_FORMAT}}

# Set pane titles and colors
{{PANE_0_CONFIG}}

{{PANE_1_CONFIG}}

{{PANE_2_CONFIG}}

{{PANE_3_CONFIG}}

# ============================================================================
# Git Remote Management (if enabled)
# ============================================================================

{{GIT_REMOTE_SETUP}}

# ============================================================================
# Claude CLI Auto-start (if enabled)
# ============================================================================

# Auto-start Claude CLI if --claude flag is provided
if [[ "$AUTO_START_CLAUDE" == true ]]; then
  echo "Auto-starting Claude CLI in all panes..."
  for pane in 0 1 2 3; do
    tmux send-keys -t "$SESSION:$WINDOW.$pane" "claude" C-m
  done
fi

# ============================================================================
# Session Attachment
# ============================================================================

# Select ancestor pane (pane 0) and attach
tmux select-pane -t "$SESSION:$WINDOW.0"
tmux attach-session -t "$SESSION"
